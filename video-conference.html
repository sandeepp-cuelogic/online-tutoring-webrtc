<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>WebRTC | Collaborative Whiteboard</title>

<!-- Google fonts -->
<link href='/assets/font1.css' rel='stylesheet' type='text/css'>
<link href='/assets/font1.css' rel='stylesheet' type='text/css'>

<!-- font awesome -->
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

<!-- bootstrap -->
<link rel="stylesheet" href="assets/bootstrap.css" />

<!-- favicon -->
<link rel="shortcut icon" href="images/favicon.png" type="image/x-icon">
<link rel="icon" href="images/favicon.png" type="image/x-icon">

<link rel="stylesheet" href="assets/style.css">

<script src="/dist/jquery-1.11.2.min.js" type="text/javascript" ></script>

</head>

<body id="home">

<!-- header -->
<nav class="navbar  navbar-default" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://www.cuelogic.com/">Online Tutoring (WebRTC)</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse navbar-right" id="bs-example-navbar-collapse-1">
      
      <ul class="nav navbar-nav">        
        <li><a href="#">Home </a></li>
        <li><a href="#">About</a></li>        
        <li><a href="#">Contact</a></li>
      </ul>
      
    </div><!-- Wnavbar-collapse -->
  </div><!-- container-fluid -->
</nav>
<!-- header -->

<!-- reservation-information -->
<div id="information" class="spacer reserve-info "><h6></h6>

<div class="container">

<div class="row">


<div class="col-sm-7 col-md-12" style="position: static; display: none" id="recorded-section">
    <div id="video-record"></div> 
</div>



<div id="main-section">

<div class="col-sm-7 col-md-8" style="position: static;">
<div class="board drawing-board" id="default-board"></div> 
    <div id="whiteboard-container">
        <!-- <canvas id="myCanvas" width="750" height="420" style="border: 1px solid;"></canvas>  --> 
        <canvas id="myCanvas"></canvas>
    </div>
</div>


<div class="col-sm-5 col-md-4">
<!-- <h3>Peer Connections</h3> -->           

        <div class="form-group" id="record-btns" style="display: none;">                        
            <button class="btn btn-default" id="start">Start Recording</button> 
            <button class="btn btn-default" id="stop" disabled>Stop Recording</button>
        </div>

        <div class="form-group" id="record-section">
            <p id="download-link"></p>            
        </div>
    
        <div class="form-group">
            <label>Room Name:</label>
            <input type="text" class="form-control"  placeholder="Name" id="room-id" value="abcdef" autocorrect=off autocapitalize=off size=20>
        </div>    

        <div class="form-group" id="share-url" style="display: none;">

        <label>Copy and share this link:</label>
            <input type="text" class="form-control" id="room-url">
        </div>                
        
        <button class="btn btn-default" id="open-room">Open Room</button>
        <button class="btn btn-default" id="join-room">Join Room</button>               
        <button class="btn btn-default" id="open-or-join-room" style="display: none;">Auto Open Or Join Room</button>        


        <div class="form-group" id="videos-container">

        <label></label>
            
        </div> 

    

    <input type="file" id="file" style="display:none;">   
</div>
</div>
</div>  
</div>
</div>
<!-- reservation-information -->

<footer class="spacer">
        <div class="container">
            <div class="row">
                <div class="col-sm-5">
                    <h4>Online Tutoring (WebRTC) </h4>
                    <p><strong>WebRTC</strong> is a free, open project that provides browsers and mobile applications with Real-Time Communications (RTC) capabilities via simple APIs. The WebRTC components have been optimized to best serve this purpose. </p>
                    <p><strong>WebRTC</strong> uses RTCPeerConnection to communicate streaming data between browsers, but also needs a mechanism to coordinate communication and to send control messages, a process known as signaling. Signaling methods and protocols are not specified by WebRTC.</p>
                </div>              
                 
                <div class="col-sm-3">
                    
                </div>

                <div class="col-sm-4 subscribe">
                    <h4>Subscription</h4>
                    <div class="input-group">
                    <input type="text" class="form-control" placeholder="Enter email id here">
                    <span class="input-group-btn">
                    <button class="btn btn-default" type="button">Get Notify</button>
                    </span>
                    </div>
                    <div class="social">
                    <a href="#"><i class="fa fa-facebook-square" data-toggle="tooltip" data-placement="top" data-original-title="facebook"></i></a>
                    <a href="#"><i class="fa fa-instagram"  data-toggle="tooltip" data-placement="top" data-original-title="instragram"></i></a>
                    <a href="#"><i class="fa fa-twitter-square" data-toggle="tooltip" data-placement="top" data-original-title="twitter"></i></a>
                    <a href="#"><i class="fa fa-pinterest-square" data-toggle="tooltip" data-placement="top" data-original-title="pinterest"></i></a>
                    <a href="#"><i class="fa fa-tumblr-square" data-toggle="tooltip" data-placement="top" data-original-title="tumblr"></i></a>
                    <a href="#"><i class="fa fa-youtube-square" data-toggle="tooltip" data-placement="top" data-original-title="youtube"></i></a>
                    </div>
                </div>
            </div>
            <!--/.row--> 
        </div>
        <!--/.container-->    
    
    <!--/.footer-bottom--> 
</footer>

<div class="text-center copyright">Powered by <a href="http://www.cuelogic.com/">www.cuelogic.com</a></div>


<script src="/dist/RTCMultiConnection.min.js"></script>

<!-- For audio and screen recording -->
<script src="/dist/RecordRTC.js"></script>
<script src="/dist/screenshot.js"></script>



<!-- custom layout for HTML5 audio/video elements -->
<script src="/dist/getMediaElement.js"></script>

<!-- socket.io for signaling -->
<script src="/socket.io/socket.io.js"></script>

<!-- Whiteboard -->
<script src="/dist/whiteboard.js"></script>

<script src="board/simple-undo.js"></script>

<script src="board/utils.js"></script>
<script src="board/board.js"></script>
<script src="board/controls/control.js"></script>
<script src="board/controls/color.js"></script>
<script src="board/controls/drawingmode.js"></script>
<script src="board/controls/navigation.js"></script>
<script src="board/controls/size.js"></script>
<script src="board/controls/download.js"></script>


<script> 

$(document).ready(function(){

    
    $('.drawing-board-control-navigation-forward').remove();
    $('.drawing-board-control-navigation-back').remove();
    //$('.drawing-board-control-drawingmode-pencil-button').remove(); 
    //$('.drawing-board-control-drawingmode-eraser-button').remove();
    $('.drawing-board-control-drawingmode-filler-button ').remove();
    $(".drawing-board-canvas-wrapper").remove();     


    $('.drawing-board-controls').append('<div class="drawing-board-control drawing-board-control-drawingmode"><button class="drawing-board-control-drawingmode-upload-button" onclick=$("#file").trigger("click");></button></div>'); 


    $('.drawing-board-controls').append('<div class="drawing-board-control drawing-board-control-undo"><button class="drawing-board-control-drawingmode-undo-button" id="btn-undo" title="Undo"></button></div>'); 

    $('.drawing-board-controls').append('<div class="drawing-board-control drawing-board-control-redo"><button class="drawing-board-control-drawingmode-redo-button" id="btn-redo" title="Redo"></button></div>'); 



    $('.drawing-board-control-drawingmode-upload-button').attr('title', 'Upload Image');
    $('.drawing-board-control-download-button').attr('title', 'Download');  
    $('.drawing-board-control-inner').attr('title', 'Pen Size');
    $('.drawing-board-control-navigation-reset').attr('title', 'Clear');
    $('.drawing-board-control-colors-current').attr('title', 'Color');

});


// Prevent scrolling when touching the canvas
var myCanvas = $('#myCanvas')[0];

document.body.addEventListener("touchstart", function (e) {
  if (e.target == myCanvas) {
    e.preventDefault();
  }
}, false);
document.body.addEventListener("touchend", function (e) {
  if (e.target == myCanvas) {
    e.preventDefault();
  }
}, false);
document.body.addEventListener("touchmove", function (e) {
  if (e.target == myCanvas) {
    e.preventDefault();
  }
}, false);



//create the drawingboard by passing it the #id of the wanted container
var defaultBoard = new DrawingBoard.Board('default-board',{color: "#969696"});

var globColor = "#969696";


var socket = io();
      socket.on("connect", function() {        
        /* at this point we have connected to the server,
        so we can call our initialization function.
        We pass our canvas (#myCanvas) and socket */
        whiteboard.init($("#myCanvas"), socket);                                    

});

  socket.on('user image', loadImage);


  socket.on("undo_move", function(){
    //canvas.undoStep();
    whiteboard.cUndo($("#myCanvas"));
    
  });


  socket.on("redo_move", function(){
    //canvas.undoStep();
    whiteboard.cRedo($("#myCanvas"));
    
  });


  function loadImage(from, base64Image) {

    //whiteboard.uploadImage(base64Image,socket);

    var $img = $('<img>', { src: base64Image });
     var canvas = $('#myCanvas')[0];
     var context = canvas.getContext('2d');

     $img.load(function() {     

           context.drawImage(this, 0, 0);
    });

    whiteboard.saveWhiteboard($("#myCanvas"));                 
  }


$(window).load(function() {
     document.getElementById('btn-undo').onclick = function() {
               
        //whiteboard.cUndo($("#myCanvas"));

        socket.emit("undoing_move");
    };

    document.getElementById('btn-redo').onclick = function() {
               
        //whiteboard.cRedo($("#myCanvas"));

        socket.emit("redoing_move");
    };
});


// document.getElementById('eraser').onclick = function() {        
    
//     whiteboard.setColor('#FFF');
// }
  



// ......................................................
// .......................UI Code........................
// ......................................................

document.getElementById('open-room').onclick = function() {
    //document.getElementById('btn-share-part-of-sreen').disabled = false;
    disableInputButtons();
    connection.open(document.getElementById('room-id').value, function() {
        showRoomURL(connection.sessionid);
    });
};

document.getElementById('join-room').onclick = function() {
    disableInputButtons();
    connection.join(document.getElementById('room-id').value);
};

document.getElementById('open-or-join-room').onclick = function() {
    disableInputButtons();
    connection.openOrJoin(document.getElementById('room-id').value, function(isRoomExists, roomid) {
        if(!isRoomExists) {
            showRoomURL(roomid);
        }
    });
};


// ......................................................
// ..................RTCMultiConnection Code.............
// ......................................................

var connection = new RTCMultiConnection();

// by default, socket.io server is assumed to be deployed on your own URL
connection.socketURL = '/';

connection.socketMessageEvent = 'video-conference-demo';

connection.session = {
    audio: true,
    video: true,
    data: true
};

connection.sdpConstraints.mandatory = {
    OfferToReceiveAudio: true,
    OfferToReceiveVideo: true,
    OfferToReceiveData: true
};

connection.videosContainer = document.getElementById('videos-container');
connection.onstream = function(event) {
    var width = parseInt(connection.videosContainer.clientWidth / 2) - 20;
    var mediaElement = getMediaElement(event.mediaElement, {
        title: event.userid,
        buttons: ['full-screen','mute-audio','stop'],
        width: width,
        showOnMouseEnter: false
    });

    connection.videosContainer.appendChild(mediaElement);

    setTimeout(function() {
        mediaElement.media.play();
    }, 5000);

    mediaElement.id = event.streamid;
};

connection.onstreamended = function(event) {
    var mediaElement = document.getElementById(event.streamid);
    if(mediaElement) {
        mediaElement.parentNode.removeChild(mediaElement);
    }
};

function disableInputButtons() {
    document.getElementById('open-or-join-room').disabled = true;
    document.getElementById('open-room').disabled = true;
    document.getElementById('join-room').disabled = true;
    document.getElementById('room-id').disabled = true;
}

// ......................................................
// ......................Handling Room-ID................
// ......................................................

function showRoomURL(roomid) {
    var roomHashURL = '#' + roomid;
    var roomQueryStringURL = '?roomid=' + roomid;

    var html = '<h2>Unique URL for your room:</h2><br>';

    html += 'Hash URL: <a href="' + roomHashURL + '" target="_blank">' + roomHashURL + '</a>';
    html += '<br>';
    html += 'QueryString URL: <a href="' + roomQueryStringURL + '" target="_blank">' + roomQueryStringURL + '</a>';

    // var roomURLsDiv = document.getElementById('room-urls');
    // roomURLsDiv.innerHTML = html;

    // roomURLsDiv.style.display = 'block';

    var shareUrl = document.getElementById('share-url');
    shareUrl.style.display = 'block';

    var urlInput = document.getElementById('room-url');
    urlInput.value = window.location.href+roomQueryStringURL;


    var recordBtns = document.getElementById('record-btns');
    recordBtns.style.display = 'block';
}

(function() {
    var params = {},
        r = /([^&=]+)=?([^&]*)/g;

    function d(s) {
        return decodeURIComponent(s.replace(/\+/g, ' '));
    }
    var match, search = window.location.search;
    while (match = r.exec(search.substring(1)))
        params[d(match[1])] = d(match[2]);
    window.params = params;
})();

var roomid = '';
if (localStorage.getItem(connection.socketMessageEvent)) {
    roomid = localStorage.getItem(connection.socketMessageEvent);
} else {
    roomid = connection.token();
}
document.getElementById('room-id').value = roomid;
document.getElementById('room-id').onkeyup = function() {
    localStorage.setItem(connection.socketMessageEvent, this.value);
};

var hashString = location.hash.replace('#', '');
if(hashString.length && hashString.indexOf('comment-') == 0) {
  hashString = '';
}

var roomid = params.roomid;
if(!roomid && hashString.length) {
    roomid = hashString;
}

if(roomid && roomid.length) {
    document.getElementById('room-id').value = roomid;
    localStorage.setItem(connection.socketMessageEvent, roomid);

    // auto-join-room
    (function reCheckRoomPresence() {
        connection.checkPresence(roomid, function(isRoomExists) {
            if(isRoomExists) {
                connection.join(roomid);
                return;
            }

            setTimeout(reCheckRoomPresence, 5000);
        });
    })();

    disableInputButtons();
}

function addImage()
{
    var img = prompt("Enter the URL of the image.");
    if(img !== '') $('#file').trigger("change");
}


$('#file').bind('change', function(e){
      var data = e.originalEvent.target.files[0];
      var reader = new FileReader();

      reader.onload = function(evt){
        loadImage('me', evt.target.result);
        socket.emit('user image', evt.target.result);
      };
      reader.readAsDataURL(data);
      
    });






    // ......................................................
    // ......................Handling Record Session.........
    // ......................................................
    

    // var elementToShare = document.getElementById('information');
    // var canvas2d = document.createElement('canvas');
    // var context = canvas2d.getContext('2d');

    // canvas2d.width = elementToShare.clientWidth;
    // canvas2d.height = elementToShare.clientHeight;

    // canvas2d.style.top = 0;
    // canvas2d.style.left = 0;
    // canvas2d.style.zIndex = -1;
    // (document.body || document.documentElement).appendChild(canvas2d);


    var isRecordingStarted = false;
    var isStoppedRecording = false;


    var canvasObj = document.getElementById('myCanvas');
    var recordAudio;
    var recordVideo;

    var canvasRecorder = RecordRTC(canvasObj, {
        type: 'canvas',        
        width: 320,
        height: 240
    });

    
    document.getElementById('start').onclick = function() {
        
        this.disabled = true;
        navigator.getUserMedia({ audio: true, video:true }, function(stream) {
            var audio = document.createElement('audio');
            audio.muted = true;
            audio.volume = 0;
            audio.src = URL.createObjectURL(stream);

            recordAudio = RecordRTC(stream, {
                type: 'audio',
                mimeType: 'audio/webm',
                recorderType: StereoAudioRecorder,
                bufferSize: typeof params.bufferSize == 'undefined' ? 0 : parseInt(params.bufferSize),
                sampleRate: typeof params.sampleRate == 'undefined' ? 44100 : parseInt(params.sampleRate),
                leftChannel: params.leftChannel || false,
                disableLogs: params.disableLogs || false,
                // recorderType: webrtcDetectedBrowser === 'edge' ? StereoAudioRecorder : null
            });



            recordVideo = RecordRTC(stream, {
                type: 'video',  
                width: 320,
                height: 240              
            });

            isStoppedRecording = false;
            isRecordingStarted = true;

            canvasRecorder.startRecording();
            recordAudio.startRecording();
            recordVideo.startRecording();

            document.getElementById('stop').disabled = false;
        }, function(error) { log( JSON.stringify ( error ) ); });
    };


    document.getElementById('stop').onclick = function() {
        document.getElementById('download-link').innerHTML = "Processing please wait...";
        this.disabled = true;
        recordAudio.stopRecording(function() {
            isStoppedRecording = true;
            canvasRecorder.stopRecording(function() {
                recordVideo.stopRecording(function(){
                    convertStreams(canvasRecorder.getBlob(), recordAudio.getBlob());
                    log('<a href="'+ workerPath +'" download="ffmpeg-asm.js">ffmpeg-asm.js</a> file download started. It is about 18MB in size; please be patient!');
                });                
            });
        });

        document.getElementById('start').disabled = false;
    };

    
    var workerPath = 'https://archive.org/download/ffmpeg_asm/ffmpeg_asm.js';
    

    function processInWebWorker() {
        var blob = URL.createObjectURL(new Blob(['importScripts("' + workerPath + '");var now = Date.now;function print(text) {postMessage({"type" : "stdout","data" : text});};onmessage = function(event) {var message = event.data;if (message.type === "command") {var Module = {print: print,printErr: print,files: message.files || [],arguments: message.arguments || [],TOTAL_MEMORY: 268435456};postMessage({"type" : "start","data" : Module.arguments.join(" ")});postMessage({"type" : "stdout","data" : "Received command: " +Module.arguments.join(" ") +((Module.TOTAL_MEMORY) ? ".  Processing with " + Module.TOTAL_MEMORY + " bits." : "")});var time = now();var result = ffmpeg_run(Module);var totalTime = now() - time;postMessage({"type" : "stdout","data" : "Finished processing (took " + totalTime + "ms)"});postMessage({"type" : "done","data" : result,"time" : totalTime});}};postMessage({"type" : "ready"});'], {
            type: 'application/javascript'
        }));

        var worker = new Worker(blob);
        URL.revokeObjectURL(blob);
        return worker;
    }

    var worker;


    function convertStreams(videoBlob, audioBlob) {
        var vab;
        var aab;
        var buffersReady;
        var workerReady;
        var posted = false;

        var fileReader1 = new FileReader();
        fileReader1.onload = function() {
            vab = this.result;

            if (aab) buffersReady = true;

            if (buffersReady && workerReady && !posted) postMessage();
        };
        var fileReader2 = new FileReader();
        fileReader2.onload = function() {
            aab = this.result;

            if (vab) buffersReady = true;

            if (buffersReady && workerReady && !posted) postMessage();
        };

        fileReader1.readAsArrayBuffer(videoBlob);
        fileReader2.readAsArrayBuffer(audioBlob);

        if (!worker) {
            worker = processInWebWorker();
        }

        worker.onmessage = function(event) {
            var message = event.data;
            if (message.type == "ready") {
                log('<a href="'+ workerPath +'" download="ffmpeg-asm.js">ffmpeg-asm.js</a> file has been loaded.');
                workerReady = true;
                if (buffersReady)
                    postMessage();
            } else if (message.type == "stdout") {
                log(message.data);
            } else if (message.type == "start") {
                log('<a href="'+ workerPath +'" download="ffmpeg-asm.js">ffmpeg-asm.js</a> file received ffmpeg command.');
            } else if (message.type == "done") {
                log(JSON.stringify(message));

                var result = message.data[0];
                log(JSON.stringify(result));

                var blob = new Blob([result.data], {
                    type: 'video/webm'
                });

                log(JSON.stringify(blob));

                PostBlob(blob);
            }
        };
        var postMessage = function() {
            posted = true;

            worker.postMessage({
                type: 'command',
                arguments: [
                    '-i', 'video.webm',
                    '-i', 'audio.wav',
                    '-c:v', 'mpeg4',
                    '-c:a', 'vorbis',
                    '-b:v', '6400k',
                    '-b:a', '4800k',
                    '-strict', 'experimental', 'output.mp4'
                ],
                files: [
                    {
                        data: new Uint8Array(vab),
                        name: 'video.webm'
                    },
                    {
                        data: new Uint8Array(aab),
                        name: "audio.wav"
                    }
                ]
            });
        };
    }

    var h6 = document.querySelector('h6');
    var newLink = "";

    function PostBlob(blob) {
        
        //h6.innerHTML = '<a href="' + URL.createObjectURL(blob) + '" target="_blank" download="Recorded Audio+Canvas File.mp4">Download Recorded Audio+Canvas file in MP4 container and play in VLC player!</a>';
        //h6.setAttribute('contenteditable', 'false');

        newLink =  '<a href="' + URL.createObjectURL(blob) + '" target="_blank" download="Recorded Audio+Canvas File.mpeg4">Please click here to download file!</a>'; 

        //document.getElementById('download-link').innerHTML = newLink;   

        document.getElementById('download-link').style.display = 'none';

        var aTag = document.createElement('a');
        aTag.setAttribute("onclick","funHideMain();");
        aTag.style.cursor = "pointer";
        aTag.innerHTML = "Click to view recorded session";
        aTag.target = "_blank";
        document.getElementById('record-section').appendChild(aTag);

        //display(blob); 
    }

    function log(message) {
        //h6.innerHTML = message;
        console.log(message);
    }

    function funHideMain(){
        var mainSec = document.getElementById('main-section');
        mainSec.style.display = 'none';

        var recordSec = document.getElementById('recorded-section');
        recordSec.style.display = 'block';


        var blob = canvasRecorder.getBlob();

        localStorage.setItem('canvasBlob',blob);

        var video = document.createElement('video');
        video.src = URL.createObjectURL(blob);
        video.setAttribute('style', 'width:70%');
        //video.setAttribute('style', 'float:left');
        video.style.float = "left";
        video.setAttribute('style', 'padding:5px');
        document.getElementById("video-record").appendChild(video);
        video.controls = true;
        video.play();


        var vBlob = recordVideo.getBlob();

        var vvideo = document.createElement('video');
        vvideo.src = URL.createObjectURL(vBlob);
        vvideo.setAttribute('style', 'width:30%');
        document.getElementById("video-record").appendChild(vvideo);
        vvideo.controls = true;
        vvideo.play();
        
    }

    function display(blob){


        // var remoteVideo = document.createElement("video");
        // remoteVideo.id = "rvideo";
        // remoteVideo.autoplay = false;
        // remoteVideo.type = "video/mpeg4";
        // remoteVideo.controls = true;
        // remoteVideo.src = URL.createObjectURL(blob);  
        // //remoteVideo.style.width= '20%';      
        // document.getElementById("video-record").append(remoteVideo);
        // console.log('Creation complete!');

        // var videoRec = document.getElementById("recorded-video");        
        // videoRec.src = URL.createObjectURL(vid);



        var blob = canvasRecorder.getBlob();

        localStorage.setItem('canvasBlob',blob);

        var video = document.createElement('video');
        video.src = URL.createObjectURL(blob);
        video.setAttribute('style', 'height: 50%; width:50%');
        document.getElementById("video-record").appendChild(video);
        video.controls = true;
        video.play();


        var vBlob = recordVideo.getBlob();

        var vvideo = document.createElement('video');
        vvideo.src = URL.createObjectURL(vBlob);
        vvideo.setAttribute('style', 'height: 50%; width:50%');
        document.getElementById("video-record").appendChild(vvideo);
        vvideo.controls = true;
        vvideo.play();
    }    

</script>


<!-- <script src="/dist/ffmpeg_asm.js" async> </script> -->

</body>
</html>





